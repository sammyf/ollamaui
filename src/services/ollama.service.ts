import { Injectable, Renderer2 } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import {
  Answer,
  LLMAnswer,
  Model,
  ModelRedux,
  Models,
  Prompt,
} from '../models/ollama.models';
import { CookieStorageService } from './cookie-storage.service';
import { lastValueFrom } from 'rxjs';
import { mockJson } from '../mocks/mockJson';

@Injectable({
  providedIn: 'root',
})
export class OllamaService {
  fakeJson: string = mockJson;

  // fakeJson:string = '{"models":[{"name":"llama31-ablated-s:latest","model":"llama31-ablated-s:latest","modified_at":"2024-07-27T21:45:16.114383572+02:00","size":7042226845,"digest":"031fbc6e24c690fde8df1b983be8680c3aa0cfbb5cfea08dea7579c2a08331d2","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"8.0B","quantization_level":"Q5_K_M"}},{"name":"llama31-ablated:latest","model":"llama31-ablated:latest","modified_at":"2024-07-27T20:57:44.235671279+02:00","size":9525779099,"digest":"e237140c345e003e41ff31642ea92edb6dc98c61d4f2d2dcec0deb7b33e57cca","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"8.0B","quantization_level":"Q8_0"}},{"name":"mistral-nemo:latest","model":"mistral-nemo:latest","modified_at":"2024-07-24T22:55:50.177784754+02:00","size":7071713233,"digest":"4b300b8c6a97834127b27f6cf5b9923f97693ceffa287d417fec7445b9ca5400","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"12.2B","quantization_level":"Q4_0"}},{"name":"llama3.1:latest","model":"llama3.1:latest","modified_at":"2024-07-24T14:40:18.715968187+02:00","size":4661226402,"digest":"a340353013fdd762755b791c475fc4781d9f77019fe25ece2ce76e3135f5b8c8","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"8.0B","quantization_level":"Q4_0"}},{"name":"nous-hermes2-mixtral:latest","model":"nous-hermes2-mixtral:latest","modified_at":"2024-07-13T17:48:25.261828331+02:00","size":26442493141,"digest":"599da8dce2c14e54737c51f9668961bbc3526674249d3850b0875638a3e5e268","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"47B","quantization_level":"Q4_0"}},{"name":"cas/sauerkrautlm-7b-laserchat:latest","model":"cas/sauerkrautlm-7b-laserchat:latest","modified_at":"2024-07-03T13:26:55.203060429+02:00","size":4368451315,"digest":"33f437181a06a4a1b8ab94b1ded577a998663b19e4efd4248cb8e787c1a29b3b","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"7B","quantization_level":"Q4_K_M"}},{"name":"sauerkrautlm-una-solar-instruct:latest","model":"sauerkrautlm-una-solar-instruct:latest","modified_at":"2024-07-03T12:53:04.51107428+02:00","size":7598867822,"digest":"0a020dbda918171efef7ff2de4240a78c8b30bfa307ce07b7f7d1cbb6a68e128","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"10.7B","quantization_level":"Q5_K_M"}},{"name":"socialnetwooky/sauerkrautlm-una-solar-instruct:latest","model":"socialnetwooky/sauerkrautlm-una-solar-instruct:latest","modified_at":"2024-07-03T12:53:04.51107428+02:00","size":7598867822,"digest":"0a020dbda918171efef7ff2de4240a78c8b30bfa307ce07b7f7d1cbb6a68e128","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"10.7B","quantization_level":"Q5_K_M"}},{"name":"codestral:latest","model":"codestral:latest","modified_at":"2024-06-25T08:31:36.665732867+02:00","size":12569170041,"digest":"fcc0019dcee9947fe4298e23825eae643f4670e391f205f8c55a64c2068e9a22","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"22.2B","quantization_level":"Q4_0"}},{"name":"gemma:latest","model":"gemma:latest","modified_at":"2024-06-12T16:00:35.472858729+02:00","size":5011853225,"digest":"a72c7f4d0a15522df81486d13ce432c79e191bda2558d024fbad4362c4f7cbf8","details":{"parent_model":"","format":"gguf","family":"gemma","families":["gemma"],"parameter_size":"9B","quantization_level":"Q4_0"}},{"name":"llava-phi3:latest","model":"llava-phi3:latest","modified_at":"2024-06-12T15:06:08.670587875+02:00","size":2926568956,"digest":"c7edd7b8759394f9995a9394b97a29aeff7ee9c921054a210347326287d300f2","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama","clip"],"parameter_size":"4B","quantization_level":"Q4_K_M"}},{"name":"aya:35b","model":"aya:35b","modified_at":"2024-06-12T14:53:24.072964132+02:00","size":20229452808,"digest":"bab44e0094403564071fc1a552135db085b9f3c3791d71b68a4c7896d56c011e","details":{"parent_model":"","format":"gguf","family":"command-r","families":["command-r"],"parameter_size":"35.0B","quantization_level":"F16"}},{"name":"aya:latest","model":"aya:latest","modified_at":"2024-06-11T18:45:48.037228863+02:00","size":4797474023,"digest":"7ef8c4942023233f441474200440ada6cb37ca276e52861e0fe8dd7aea570224","details":{"parent_model":"","format":"gguf","family":"command-r","families":["command-r"],"parameter_size":"8.0B","quantization_level":"F16"}},{"name":"moondream:latest","model":"moondream:latest","modified_at":"2024-05-06T09:43:16.774738994+02:00","size":1738451181,"digest":"ad0714b7b564d9f658cb78befffffb74d688bfa8e624a557152518aa8bff159e","details":{"parent_model":"","format":"gguf","family":"phi2","families":["phi2","clip"],"parameter_size":"1B","quantization_level":"Q4_0"}},{"name":"dolphin-llama3:latest","model":"dolphin-llama3:latest","modified_at":"2024-04-26T10:44:51.469583217+02:00","size":4661235994,"digest":"613f068e29f863bb900e568f920401b42678efca873d7a7c87b0d6ef4945fadd","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"8B","quantization_level":"Q4_0"}},{"name":"lexillama:latest","model":"lexillama:latest","modified_at":"2024-04-24T09:08:11.255928987+02:00","size":5599294459,"digest":"eccc832db48e1ea1cc752a6e1a6cac874289556d2bb4dd155aab96fcc077e611","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"8B","quantization_level":"Q5_K_S"}},{"name":"bigphi:latest","model":"bigphi:latest","modified_at":"2024-04-24T08:58:53.447764483+02:00","size":2815275260,"digest":"11e7224c8009ca12e9cb9ae8bba215554970a834ed0bb2dc6edb056e3f2e1587","details":{"parent_model":"","format":"gguf","family":"phi3","families":["phi3"],"parameter_size":"4B","quantization_level":"Q5_K_M"}},{"name":"phi3:latest","model":"phi3:latest","modified_at":"2024-04-23T23:02:56.89870187+02:00","size":2318920898,"digest":"a2c89ceaed85371d0b8a51b5cc70ff054acc37465ea25e72e1612fe28bce7ad9","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"4B","quantization_level":"Q4_K_M"}},{"name":"Lara-cmdr:latest","model":"Lara-cmdr:latest","modified_at":"2024-04-20T09:24:50.016142817+02:00","size":20229444964,"digest":"fd0138e0570d183a9a39c29133813766bcd7c16721a77ba8260f7d86f2cfdbbb","details":{"parent_model":"","format":"gguf","family":"command-r","families":["command-r"],"parameter_size":"35B","quantization_level":"Q4_0"}},{"name":"command-r:latest","model":"command-r:latest","modified_at":"2024-04-20T08:57:02.34277741+02:00","size":20229443783,"digest":"b8cdfff0263c7ca8648617d404afcb2f7db20ba539bb83bf6ff2af060e1abf0b","details":{"parent_model":"","format":"gguf","family":"command-r","families":["command-r"],"parameter_size":"35B","quantization_level":"Q4_0"}},{"name":"wizardlm2:latest","model":"wizardlm2:latest","modified_at":"2024-04-19T09:58:57.05353821+02:00","size":4108928625,"digest":"c9b1aff820f245a43b1719b296ce7131746073691cbb56f7a8d88a4713a3df79","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"dolphincoder:latest","model":"dolphincoder:latest","modified_at":"2024-03-12T07:20:17.594465409+01:00","size":9065431309,"digest":"1102380927c2a044bf9ec8717e24d43270b71398bf48ede49c92947d3fed653d","details":{"parent_model":"","format":"gguf","family":"starcoder2","families":["starcoder2"],"parameter_size":"16B","quantization_level":"Q4_0"}},{"name":"dolphin2.2-mistral:latest","model":"dolphin2.2-mistral:latest","modified_at":"2024-02-23T08:45:44.75488153+01:00","size":4108929227,"digest":"2a32ad1a1bfdc476f7e27cf0f6f0b4ca09d8c750cf32345908833d97c494f66a","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"dolphin2.1-mistral:latest","model":"dolphin2.1-mistral:latest","modified_at":"2024-02-23T08:45:20.661473538+01:00","size":4108928340,"digest":"5af5443c09e42559dd477879f115cabb2e95ad481cd54b5022d43c7a3c9a7a64","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"stablelm2:latest","model":"stablelm2:latest","modified_at":"2024-02-23T07:31:04.728108561+01:00","size":982790018,"digest":"1b81980a10e6dfbeeebba98fd4aac12ad3460128c8836d09c8bd84864f9d1fa4","details":{"parent_model":"","format":"gguf","family":"stablelm","families":["stablelm"],"parameter_size":"2B","quantization_level":"Q4_0"}},{"name":"dolphin-mixtral:latest","model":"dolphin-mixtral:latest","modified_at":"2024-02-10T15:07:05.102302604+01:00","size":26441556600,"digest":"cfada4ba31c706daf694d70a9d4c79cb617742d9189b530db55c138d1c966e46","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"47B","quantization_level":"Q4_0"}},{"name":"llava:34b","model":"llava:34b","modified_at":"2024-02-03T16:57:34.446483145+01:00","size":20166497526,"digest":"3d2d24f4667475bd28d515495b0dcc03b5a951be261a0babdb82087fc11620ee","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama","clip"],"parameter_size":"34B","quantization_level":"Q4_0"}},{"name":"llava:13b","model":"llava:13b","modified_at":"2024-02-03T16:53:27.002437831+01:00","size":8011256494,"digest":"0d0eb4d7f485d7d0a21fd9b0c1d5b04da481d2150a097e81b64acb59758fdef6","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama","clip"],"parameter_size":"13B","quantization_level":"Q4_0"}},{"name":"llava:7b","model":"llava:7b","modified_at":"2024-02-03T16:50:03.074041017+01:00","size":4733363377,"digest":"8dd30f6b0cb19f555f2c7a7ebda861449ea2cc76bf1f44e262931f45fc81d081","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama","clip"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"tinydolphin:latest","model":"tinydolphin:latest","modified_at":"2024-01-23T08:02:07.424760113+01:00","size":636743847,"digest":"97c9685cc5dbb80e90e60f96b7c7bd893b1f579b97a9e852879b34840b46a4cb","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"1B","quantization_level":"Q4_0"}},{"name":"tinybob:latest","model":"tinybob:latest","modified_at":"2024-01-22T12:57:15.141066546+01:00","size":637700138,"digest":"2644915ede352ea7bdfaff0bfac0be74c719d5d5202acb63a6fb095b52f394a4","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"1B","quantization_level":"Q4_0"}},{"name":"tinyllama:latest","model":"tinyllama:latest","modified_at":"2024-01-22T08:11:37.454325276+01:00","size":637700138,"digest":"2644915ede352ea7bdfaff0bfac0be74c719d5d5202acb63a6fb095b52f394a4","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"1B","quantization_level":"Q4_0"}},{"name":"phixtral-2x2:latest","model":"phixtral-2x2:latest","modified_at":"2024-01-19T11:18:21.726256902+01:00","size":2843068847,"digest":"756dfda43d3425e90e70544fdd1514c296f164442f588f55625af12993060ec1","details":{"parent_model":"","format":"gguf","family":"phi2","families":["phi2"],"parameter_size":"4B","quantization_level":"Q4_K_M"}},{"name":"nous-hermes2-mixtral:8x7b-dpo-q3_K_M","model":"nous-hermes2-mixtral:8x7b-dpo-q3_K_M","modified_at":"2024-01-17T07:43:00.430876935+01:00","size":20364314775,"digest":"e59b72c2d763e0215594cbd8760ad07ddbe5b3d9c31cb91de0a9cd2b42ef58ba","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"47B","quantization_level":"Q3_K_M"}},{"name":"Velara:latest","model":"Velara:latest","modified_at":"2024-01-14T22:19:13.528740856+01:00","size":8056239253,"digest":"ce425ae2b37ba2d16ea927bb3a62437f51cbb6fd196818b2b911bc19223020bb","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"11B","quantization_level":"Q5_K_M"}},{"name":"beyonder:latest","model":"beyonder:latest","modified_at":"2024-01-06T22:07:14.082716699+01:00","size":16635245450,"digest":"6fb7ad7227b2faf390506c152a602b5397205946de4d8dd49934b8329fbc861b","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"24B","quantization_level":"Q5_K_M"}},{"name":"openhermes:latest","model":"openhermes:latest","modified_at":"2024-01-06T17:02:51.485486586+01:00","size":4108928574,"digest":"95477a2659b7539758230498d6ea9f6bfa5aa51ffb3dea9f37c91cacbac459c1","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"dolphin-2.6:latest","model":"dolphin-2.6:latest","modified_at":"2024-01-05T11:02:30.00211592+01:00","size":26441546108,"digest":"66da6ea2432c84608af918bbe0ac0ab6dad37b9a16dca3c24daeb79116aa0b6b","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"47B","quantization_level":"Q4_K_M"}},{"name":"Solar-uncensored:latest","model":"Solar-uncensored:latest","modified_at":"2024-01-05T10:47:06.8970215+01:00","size":7598867228,"digest":"0224eecb2ee71a5b70a53bc80b346379f770eb4393cf0ce6955a2ff2eb0985f2","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"11B","quantization_level":"Q5_K_M"}},{"name":"dolphin-mistral:latest","model":"dolphin-mistral:latest","modified_at":"2024-01-02T13:25:40.297961691+01:00","size":4109870615,"digest":"206a4093ff30277a0d6ce57fb4824970930e793987436352ee790829dfab549e","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"bakllava:latest","model":"bakllava:latest","modified_at":"2023-12-31T09:14:23.729772455+01:00","size":4733351307,"digest":"3dd68bd4447cba20e20deba918749e7f58ff689a8ba4a90c9ff9dc9118037486","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama","clip"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"notux:latest","model":"notux:latest","modified_at":"2023-12-30T10:56:33.372088879+01:00","size":26442471290,"digest":"fe14e7d66184a006c5a1e7d77d0cc90efe8184fb572da7a0da384aaa1372472f","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"47B","quantization_level":"Q4_0"}},{"name":"phind-codellama:latest","model":"phind-codellama:latest","modified_at":"2023-12-30T09:45:42.369829537+01:00","size":19052056344,"digest":"566e1b629c44bb8f94b5bbaad4add8fde95257d6953bc79dab0b74afc774def1","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"34B","quantization_level":"Q4_0"}},{"name":"dolphin-phi:latest","model":"dolphin-phi:latest","modified_at":"2023-12-28T09:08:13.476986671+01:00","size":1602473850,"digest":"c5761fc772409945787240af89a5cce01dd39dc52f1b7b80d080a1163e8dbe10","details":{"parent_model":"","format":"gguf","family":"phi2","families":["phi2"],"parameter_size":"3B","quantization_level":"Q4_0"}},{"name":"wizardlm-uncensored:13b-llama2","model":"wizardlm-uncensored:13b-llama2","modified_at":"2023-12-28T07:10:21.473633913+01:00","size":7365835187,"digest":"886a369d74fcaeb3d9293e81c1de8cb87a5142521f845447c780f05d9439607a","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"13B","quantization_level":"Q4_0"}},{"name":"wizard-vicuna-uncensored:13b","model":"wizard-vicuna-uncensored:13b","modified_at":"2023-12-28T07:05:16.810525565+01:00","size":7365835082,"digest":"6887722b661837283fb4409beb9b6eb155e2146770172ad2392d9b707ff5e9fa","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"13B","quantization_level":"Q4_0"}},{"name":"llama2-uncensored:latest","model":"llama2-uncensored:latest","modified_at":"2023-12-28T06:21:28.536090106+01:00","size":3825819449,"digest":"44040b9222331f7eacd27ec9254e42de585af28d2c5d1211cdaeb3ffa361fe3f","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"mistral:instruct","model":"mistral:instruct","modified_at":"2023-12-27T21:31:45.567193778+01:00","size":4109865159,"digest":"61e88e884507ba5e06c49b40e6226884b2a16e872382c2b44a42f2d119d804a5","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"llava:latest","model":"llava:latest","modified_at":"2023-12-20T20:42:13.094717435+01:00","size":4450242073,"digest":"e4c3eb471fd8247a4afb889408cd559aba91bfbdea87c94ffefb2af9787e6bae","details":{"parent_model":"","format":"gguf","family":"llama","families":["llama","clip"],"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"medllama2:latest","model":"medllama2:latest","modified_at":"2023-12-20T20:39:24.539243274+01:00","size":3825807497,"digest":"a53737ec0c72e31e16968f232cad6a13d79b979d7c0cb13404dcd4405214c8f2","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"7B","quantization_level":"Q4_0"}},{"name":"neural-chat:latest","model":"neural-chat:latest","modified_at":"2023-12-20T13:45:05.073003445+01:00","size":4109853575,"digest":"f4c6a8e532e8f3b261911fed7689930ae3a4cd794cf5b40508c8ce31f41ccfca","details":{"parent_model":"","format":"gguf","family":"llama","families":null,"parameter_size":"7B","quantization_level":"Q4_0"}}]}'

  constructor(
    private http: HttpClient,
    private cookieStorage: CookieStorageService
  ) {}
  url: string = 'https://beezle.cosmic-bandito.com/api';

  async getModels(): Promise<Array<Model>> {
    //let models:Models = JSON.parse(this.fakeJson);

    const headers = new HttpHeaders({
      /* ... your headers ... */
    });

    try {
      const models = await lastValueFrom(
        this.http.get<Models>(
          `${this.url}/tags?cache=${Math.floor(Math.random() * 10000000)}`,
          {
            responseType: 'json',
          }
        )
      );
      return models.models;
    } catch (error) {
      console.error(error);
      return new Array<Model>();
    }
  }

  async getAnswer({ postData }: Answer): Promise<string | undefined> {
    try {
      const headers = new HttpHeaders({
        /* ... your headers ... */
      });
      const response = await lastValueFrom(
        this.http.post<LLMAnswer>(
          `${this.url}/chat?cache=${Math.floor(Math.random() * 10000000)}`,
          postData,
          {
            responseType: 'json',
          }
        )
      );
      // @ts-ignore
      return response.message.content;
    } catch (error) {
      console.error(error);
      return 'No Answer.';
    }
  }
}
